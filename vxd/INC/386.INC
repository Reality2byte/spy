FLAGS_CF	EQU	00000001H
FLAGS_PF	EQU	00000004H
FLAGS_AF	EQU	00000010H
FLAGS_ZF	EQU	00000040H
FLAGS_SF	EQU	00000080H
FLAGS_TF	EQU	00000100H
FLAGS_IF	EQU	00000200H
FLAGS_DF	EQU	00000400H
FLAGS_OF	EQU	00000800H
FLAGS_IOPL	EQU	00003000H
FLAGS_IOPL0	EQU	00000000H
FLAGS_IOPL1	EQU	00001000H
FLAGS_IOPL2	EQU	00002000H
FLAGS_IOPL3	EQU	00003000H
FLAGS_NT	EQU	00004000H
FLAGS_BIT15	EQU	00008000H
FLAGS_RF	EQU	00010000H
FLAGS_V86	EQU	00020000H
CR0_PE	EQU	00000001H
CR0_MP	EQU	00000002H
CR0_EM	EQU	00000004H
CR0_TS	EQU	00000008H
CR0_ET	EQU	00000010H
CR0_PG	EQU	80000000H
SEG_SHIFT	EQU	4
SEL_RPL0	EQU	0000H
SEL_RPL1	EQU	0001H
SEL_RPL2	EQU	0002H
SEL_RPL3	EQU	0003H
SEL_MASK	EQU	0FFF8H
SEL_SHIFT	EQU	3
SEL_LDT	EQU	0004H
SEL_V86	EQU	00010000H
SEL_PROT	EQU	00000000H
SEL_PROT32	EQU	00020000H
SEGTYPE_ACC	EQU	01H
SEGTYPE_RW	EQU	02H
SEGTYPE_CE	EQU	04H
SEGTYPE_TYPE	EQU	18H
SEGTYPE_SEG	EQU	10H
SEGTYPE_GATE	EQU	00H
SEGTYPE_GATETYPE	EQU	0FH
SEGTYPE_CODE	EQU	18H
SEGTYPE_DATA	EQU	10H
SEGTYPE_DPL	EQU	60H
SEGTYPE_DPL_0	EQU	00H
SEGTYPE_DPL_1	EQU	20H
SEGTYPE_DPL_2	EQU	40H
SEGTYPE_DPL_3	EQU	60H
SEGTYPE_PRESENT	EQU	80H
SEGTYPE_0	EQU	00H
SEGTYPE_286TSS	EQU	01H
SEGTYPE_LDT	EQU	02H
SEGTYPE_286TSSBUSY	EQU	03H
SEGTYPE_CALLGATE	EQU	04H
SEGTYPE_TASKGATE	EQU	05H
SEGTYPE_286INTGATE	EQU	06H
SEGTYPE_286TRAPGATE	EQU	07H
SEGTYPE_8	EQU	08H
SEGTYPE_386TSS	EQU	09H
SEGTYPE_A	EQU	0AH
SEGTYPE_386TSSBUSY	EQU	0BH
SEGTYPE_386CALLGATE	EQU	0CH
SEGTYPE_D	EQU	0DH
SEGTYPE_386INTGATE	EQU	0EH
SEGTYPE_386TRAPGATE	EQU	0FH
SEGLIMIT_BIG	EQU	40H
SEGLIMIT_GRANULAR	EQU	80H
SEG_386TSS	EQU	(SEGTYPE_PRESENT OR SEGTYPE_DPL_0 OR SEGTYPE_386TSS)
SEG_CODE	EQU	(SEGTYPE_PRESENT OR SEGTYPE_DPL_0 OR SEGTYPE_CODE OR SEGTYPE_RW)
SEG_DATA	EQU	(SEGTYPE_PRESENT OR SEGTYPE_DPL_0 OR SEGTYPE_DATA OR SEGTYPE_RW)

DES	STRUC
des_wLimit	DW	?
des_wBase0_15	DW	?
des_bBase16_23	DB	?
des_bType	DB	?
des_bLimit	DB	?
des_bBase24_31	DB	?
DES	ENDS

GATE	STRUC
gate_wBase0_15	DW	?
gate_wSel	DW	?
gate_bReserved	DB	?
gate_bType	DB	?
gate_wBase16_31	DW	?
GATE	ENDS

DTR	STRUC
dtr_wLimit	DW	?
dtr_dwBase	DD	?
DTR	ENDS
MAX_PORT	EQU	MAX_WORD
SIZE_IOPM	EQU	(MAX_PORT/8+1)

TSS	STRUC
tss_selBackLink	DD	?
tss_ESP0	DD	?
tss_SS0	DD	?
tss_ESP1	DD	?
tss_SS1	DD	?
tss_ESP2	DD	?
tss_SS2	DD	?
tss_CR3	DD	?
tss_EIP	DD	?
tss_Flags	DD	?
tss_EAX	DD	?
tss_ECX	DD	?
tss_EDX	DD	?
tss_EBX	DD	?
tss_ESP	DD	?
tss_EBP	DD	?
tss_ESI	DD	?
tss_EDI	DD	?
tss_ES	DD	?
tss_CS	DD	?
tss_SS	DD	?
tss_DS	DD	?
tss_FS	DD	?
tss_GS	DD	?
tss_selLDT	DD	?
tss_wTSSFlags	DW	?
tss_offIOPM	DW	?
tss_abIOPM	DB	SIZE_IOPM DUP (?)
TSS	ENDS
PAGE_SIZE	EQU	4096
PAGE_SHIFT	EQU	12
PAGE_ENTRIES	EQU	(PAGE_SIZE/4)
PG_FRAME	EQU	0FFFFF000H
PG_AVAIL	EQU	00000E00H
PG_RESERVED	EQU	00000198H
PG_DIRTY	EQU	00000040H
PG_ACCESSED	EQU	00000020H
PG_USER	EQU	00000004H
PG_WRITE	EQU	00000002H
PG_PRESENT	EQU	00000001H
PG_FRAMEINC	EQU	00001000H
IDT_DIVERROR	EQU	00H
IDT_DEBUG	EQU	01H
IDT_NMI	EQU	02H
IDT_BREAKPOINT	EQU	03H
IDT_OVERFLOW	EQU	04H
IDT_BOUNDS	EQU	05H
IDT_INVOPCODE	EQU	06H
IDT_NOCP	EQU	07H
IDT_DBLFAULT	EQU	08H
IDT_RESERVED09	EQU	09H
IDT_TSSFAULT	EQU	0AH
IDT_SEGFAULT	EQU	0BH
IDT_STACKFAULT	EQU	0CH
IDT_GPFAULT	EQU	0DH
IDT_PAGEFAULT	EQU	0EH
IDT_RESERVED0F	EQU	0FH
IDT_CPFAULT	EQU	10H
IDT_RESERVED11	EQU	11H
IDT_RESERVED12	EQU	12H
IDT_RESERVED13	EQU	13H
IDT_RESERVED14	EQU	14H
IDT_RESERVED15	EQU	15H
IDT_RESERVED16	EQU	16H
IDT_RESERVED17	EQU	17H
IDT_RESERVED18	EQU	18H
IDT_RESERVED19	EQU	19H
IDT_RESERVED1A	EQU	1AH
IDT_RESERVED1B	EQU	1BH
IDT_RESERVED1C	EQU	1CH
IDT_RESERVED1D	EQU	1DH
IDT_RESERVED1E	EQU	1EH
IDT_RESERVED1F	EQU	1FH
IDT_VMM	EQU	20H
IDT_DEBUGREQ	EQU	41H
ifndef WIN386
IDT_OFFSET	EQU	00H
else
IDT_OFFSET	EQU	30H
endif
IDT_MASTER_BASE	EQU	(20H+IDT_OFFSET)
IDT_TMR	EQU	(20H+IDT_OFFSET)
IDT_KBD	EQU	(21H+IDT_OFFSET)
IDT_SLAVE	EQU	(22H+IDT_OFFSET)
IDT_COM2	EQU	(23H+IDT_OFFSET)
IDT_COM1	EQU	(24H+IDT_OFFSET)
IDT_LPT2	EQU	(25H+IDT_OFFSET)
IDT_DISKETTE	EQU	(26H+IDT_OFFSET)
IDT_LPT1	EQU	(27H+IDT_OFFSET)
IDT_SLAVE_BASE	EQU	(28H+IDT_OFFSET)
IDT_RTC	EQU	(28H+IDT_OFFSET)
IDT_IRQ2	EQU	(29H+IDT_OFFSET)
IDT_IRQ10	EQU	(2AH+IDT_OFFSET)
IDT_IRQ11	EQU	(2BH+IDT_OFFSET)
IDT_IRQ12	EQU	(2CH+IDT_OFFSET)
IDT_CP	EQU	(2DH+IDT_OFFSET)
IDT_DISK	EQU	(2EH+IDT_OFFSET)
IDT_IRQ15	EQU	(2FH+IDT_OFFSET)
IDT_ENTRIES	EQU	(30H+IDT_OFFSET)
IDT_SIZE	EQU	(IDT_ENTRIES*SIZE DES)

ESF	STRUC
esf_hVM	DD	?
esf_defData	DD	?
esf_defStack	DD	?
esf_defOverride	DD	?
esf_dwIMRs	DD	?
esf_CR3	DD	?
esf_CR2	DD	?
esf_CR0	DD	?
esf_SS	DD	?
esf_GS	DD	?
esf_FS	DD	?
esf_ES	DD	?
esf_DS	DD	?
esf_saveES	DD	?
esf_saveDS	DD	?
esf_EDI	DD	?
esf_ESI	DD	?
esf_EBP	DD	?
esf_ESP	DD	?
esf_EBX	DD	?
esf_EDX	DD	?
esf_ECX	DD	?
esf_EAX	DD	?
esf_iTrap	DD	?
esf_iErrCode	DD	?
esf_EIP	DD	?
esf_CS	DD	?
esf_Flags	DD	?
esf_v86ESP	DD	?
esf_v86SS	DD	?
esf_v86ES	DD	?
esf_v86DS	DD	?
esf_v86FS	DD	?
esf_v86GS	DD	?
ESF	ENDS

ISF	STRUC
isf_iTrap	DD	?
isf_iErrCode	DD	?
isf_EIP	DD	?
isf_CS	DD	?
isf_Flags	DD	?
ISF	ENDS

VIRF	STRUC
virf_IP	DW	?
virf_CS	DW	?
virf_Flags	DW	?
VIRF	ENDS

Check286 macro
        pushf
        sub     ax,ax
        push    ax
        popf
        pushf
        pop     ax
        popf
        and     ax,FLAGS_IOPL or FLAGS_NT or FLAGS_BIT15
        cmp     ax,FLAGS_IOPL or FLAGS_NT or FLAGS_BIT15
endm

Check386 macro
        pushf
        mov     ax,FLAGS_IOPL or FLAGS_NT
        push    ax
        popf
        pushf
        pop     ax
        popf
        and     ax,FLAGS_IOPL or FLAGS_NT
endm

IODelay macro
        jmp     $+2
        jmp     $+2
endm


